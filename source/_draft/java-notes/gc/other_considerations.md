11 其他考虑因素
本节涵盖了影响垃圾收集的其他情况。

最终化和弱引用、软引用和幻象引用
一些应用程序通过使用最终化和弱引用、软引用或幻象引用与垃圾收集互动。这些特性可以在Java编程语言层面上产生性能问题。这方面的一个例子是依靠最终化来关闭文件描述符，这使得外部资源（描述符）依赖于垃圾收集的提示性。依靠垃圾收集来管理内存以外的资源，几乎总是一个坏主意。

前言中的相关文档部分包括一篇文章，深入讨论了最终化的一些陷阱和避免这些陷阱的技术。

明确的垃圾收集
应用程序与垃圾收集互动的另一种方式是通过调用System.gc()来显式地调用完整的垃圾收集。这可能会在没有必要的情况下强制进行一次大的收集（例如，当小的收集就足够了），所以一般来说应该避免。显式垃圾收集的性能影响可以通过使用标志-XX:+DisableExplicitGC来衡量，这使得虚拟机忽略对System.gc()的调用。

显式垃圾收集最常见的用途之一发生在远程方法调用（RMI）的分布式垃圾收集（DGC）。使用RMI的应用程序引用了其他虚拟机中的对象。在这些分布式应用中，如果不偶尔调用本地堆的垃圾收集，就无法收集垃圾，所以RMI强制定期进行全面收集。这些收集的频率可以用属性来控制，如下面的例子。

java -Dsun.rmi.dgc.client.gcInterval=3600000
    -Dsun.rmi.dgc.server.gcInterval=3600000 ...
这个例子指定了每小时一次显式垃圾收集，而不是默认的每分钟一次。然而，这也可能导致一些对象需要更长的时间才能被回收。如果不希望对DGC活动的及时性有一个上限，可以将这些属性设置为Long.MAX_VALUE，以使显式收集之间的时间实际上是无限的。

软引用
软引用在服务器虚拟机中保持活力的时间比在客户端更长。清理的速度可以通过命令行选项-XX:SoftRefLRUPolicyMSPerMB=<N>来控制，该选项指定了在堆中每一兆字节的自由空间中，软引用将被保留的毫秒（ms）数量（一旦它不再是强可达的）。默认值是每兆字节1000毫秒，这意味着在堆中每兆字节的自由空间中，软引用将存活1秒（在最后一个对象的强引用被收集后）。这是一个近似的数字，因为软引用只在垃圾收集期间被清除，而垃圾收集可能会零星发生。

类的元数据
Java类在Java Hotspot VM中有一个内部表示，被称为类元数据。在以前的Java Hotspot VM版本中，类元数据是在所谓的永久生成中分配的。在JDK 8中，永久生成被移除，类元数据被分配在本地内存中。默认情况下，可用于类元数据的本地内存的数量是无限的。使用选项MaxMetaspaceSize可以对用于类元数据的本地内存量设置一个上限。

Java Hotspot VM明确管理用于元数据的空间。空间是向操作系统请求的，然后被分成几块。类加载器从其块中为元数据分配空间（一个块被绑定到一个特定的类加载器）。当类加载器的类被卸载时，它的块被回收再利用或返回给操作系统。元数据使用由mmap分配的空间，而不是由malloc分配。

如果UseCompressedOops被打开并且UseCompressedClassesPointers被使用，那么本地内存的两个逻辑上不同的区域被用于类元数据。UseCompressedClassPointers使用32位偏移量来表示64位进程中的类指针，就像UseCompressedOops用于Java对象引用一样。一个区域被分配给这些压缩的类指针（32位偏移量）。该区域的大小可以用CompressedClassSpaceSize设置，默认为1GB。压缩类指针的空间被保留为mmap在初始化时分配的空间，并在需要时提交。MaxMetaspaceSize适用于提交的压缩类空间和其他类元数据的空间之和。

当相应的Java类被卸载时，类的元数据就会被取消分配。Java类被卸载是垃圾收集的结果，为了卸载类和去分配类元数据，可以诱导垃圾收集。当用于类元数据的空间达到一定水平（高水位线）时，就会诱发垃圾收集。在垃圾收集之后，根据从类元数据中释放出来的空间数量，高水位标志可能会被提高或降低。高水位线会被提高，以避免过早地诱发另一次垃圾收集。高水位线最初被设置为命令行选项MetaspaceSize的值。它是根据选项MaxMetaspaceFreeRatio和MinMetaspaceFreeRatio来提高或降低的。如果用于类元数据的承诺空间占类元数据总承诺空间的百分比大于MaxMetaspaceFreeRatio，那么高水位将被降低。如果它小于MinMetaspaceFreeRatio，那么高水位线将被提高。

为选项MetaspaceSize指定一个较高的值，以避免为类元数据引起的早期垃圾收集。为一个应用程序分配的类元数据的数量与应用程序有关，对于MetaspaceSize的选择不存在一般准则。MetaspaceSize的默认大小与平台有关，范围从12MB到大约20MB。

用于元数据的空间的信息包含在堆的打印输出中。一个典型的输出显示在例11-1，"典型堆打印输出 "中。

例11-1 典型的堆打印输出

堆
  PSYoungGen总计10752K，使用4419K
    [0xffffffff6ac00000, 0xffffffff6b800000, 0xffffff6b800000)
    Eden空间9216K，使用47%。
      [0xffffffff6ac00000,0xffffffff6b050d68,0xffffffff6b500000)
    从空间1536K, 0%使用
      [0xffffffff6b680000,0xffffffff6b680000,0xffffffff6b800000)
    到空间1536K，使用了0%。
      [0xffffffff6b500000,0xffffffff6b500000,0xffffffff6b680000)
  ParOldGen总计20480K，使用20011K
      [0xffffff69800000, 0xffffff6ac00000, 0xffffff6ac00000)
    对象空间 20480K, 97%被使用 
      [0xffffffff69800000,0xffffffff6ab8add8,0xffffffff6ac00000)
  元空间使用了2425K，容量4498K，承诺4864K，保留1056768K
    类空间使用了262K，容量386K，承诺512K，保留1048576K
在以Metaspace开头的一行中，已用值是用于加载类的空间量。容量值是在当前分配的块中可用于元数据的空间。承诺值是块的可用空间量。保留值是为元数据保留的空间量（但不一定是承诺的）。以类空间行开始的那一行包含了压缩类指针的元数据的相应值。